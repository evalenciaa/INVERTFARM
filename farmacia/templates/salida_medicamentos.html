{% extends 'base.html' %}
{% load static %}

{% block title %}Registro de Salidas por QR{% endblock %}

{% block extra_css %}
<!-- Estilo simple para la fila de la tabla vacía -->
<style>
    #fila-vacia td {
        padding: 20px;
        text-align: center;
        font-style: italic;
        color: #888;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="text-center mb-4"><i class="fas fa-qrcode me-2"></i>Registro de Salida de Medicamentos</h2>
    
    <!-- 
      Este es el formulario principal que enviará TODO al final. 
      Lo llenaremos con JavaScript.
    -->
    <form method="POST" id="form-salida-final" action="{% url 'registrar_salida' %}">
        {% csrf_token %}
        
        <!-- ============================================= -->
        <!-- PASO 1: DATOS DEL PACIENTE Y RECETA -->
        <!-- ============================================= -->
        <div class="card shadow mb-4">
            <div class="card-header bg-primary text-white">
                <h5><i class="fas fa-user-edit"></i> 1. Datos del Paciente y Receta</h5>
            </div>
            <div class="card-body">
                <!-- Errores generales del formulario (si los hay) -->
                {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {% for error in form.non_field_errors %}<p class="mb-0">{{ error }}</p>{% endfor %}
                    </div>
                {% endif %}

                <div class="row g-3">
                    <!-- Campo CURP -->
                    <div class="col-md-4 form-group">
                        <label for="id_paciente_curp">CURP del Paciente:</label>
                        <input type="text" name="paciente_curp" class="form-control" id="id_paciente_curp" placeholder="Escribe el CURP (18 caracteres)" maxlength="18">
                    </div>
                    <!-- Campo Nombre -->
                    <div class="col-md-5 form-group">
                        <label for="id_paciente_nombre">Nombre Completo:</label>
                        <input type="text" name="paciente_nombre" class="form-control" id="id_paciente_nombre" placeholder="Nombre ApellidoP ApellidoM" required>
                    </div>
                    <!-- Campo Fecha Nacimiento -->
                    <div class="col-md-3 form-group">
                        <label for="id_paciente_nacimiento">Fecha Nacimiento:</label>
                        <input type="date" name="paciente_nacimiento" class="form-control" id="id_paciente_nacimiento" required>
                    </div>
                    <!-- Campo Origen -->
                    <div class="col-md-6 form-group">
                        <label for="id_receta_origen">Origen de la Salida:</label>
                        <!-- Usamos el 'form' de Django para que renderice el select -->
                        {{ form.receta_origen }}
                        {% if form.receta_origen.errors %}
                            <div class="invalid-feedback d-block">{% for error in form.receta_origen.errors %}{{ error }}{% endfor %}</div>
                        {% endif %}
                    </div>
                    <!-- Campo Folio -->
                    <div class="col-md-6 form-group">
                        <label for="id_receta_folio">Folio de Receta (Opcional):</label>
                        <input type="text" name="receta_folio" class="form-control" id="id_receta_folio" placeholder="Folio de receta física si existe">
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================= -->
        <!-- PASO 2: AÑADIR MEDICAMENTOS -->
        <!-- ============================================= -->
        <div class="card shadow mb-4">
            <div class="card-header bg-danger text-white">
                <h5><i class="fas fa-barcode"></i> 2. Escanear y Añadir Medicamentos</h5>
            </div>
            <div class="card-body">
                <div class="row g-3 align-items-end">
                    <!-- Campo de Escaneo/Búsqueda -->
                    <div class="col-md-6 form-group">
                        <label for="qr_input">Escanear Lote (ID o Código):</label>
                        <input type="text" class="form-control form-control-lg" id="qr_input" placeholder="Esperando escaneo...">
                        <div id="info_message" class="mt-2"></div>
                    </div>
                    <!-- Campo Cantidad -->
                    <div class="col-md-3 form-group">
                        <label for="cantidad_input">Cantidad a Surtir:</label>
                        <input type="number" class="form-control form-control-lg" id="cantidad_input" min="1" placeholder="Ej: 5" disabled>
                    </div>
                    <!-- Botón de Añadir -->
                    <div class="col-md-3 form-group">
                        <button type="button" class="btn btn-success btn-lg w-100" id="btn-anadir-item" disabled>
                            <i class="fas fa-plus"></i> Añadir
                        </button>
                    </div>
                </div>
                
                <!-- Datos del Lote escaneado (ocultos, solo para JS) -->
                <fieldset disabled class="mt-3" id="fieldset-lote" style="display:none;">
                    <div class="row">
                        <div class="col-md-5"><input type="text" id="medicamento_nombre" class="form-control" placeholder="Medicamento"></div>
                        <div class="col-md-3"><input type="text" id="lote_numero" class="form-control" placeholder="Lote"></div>
                        <div class="col-md-2"><input type="text" id="caducidad_lote" class="form-control" placeholder="Caducidad"></div>
                        <div class="col-md-2"><input type="text" id="stock_actual" class="form-control" placeholder="Stock"></div>
                    </div>
                </fieldset>
            </div>
        </div>

        <!-- ============================================= -->
        <!-- PASO 3: LISTA DE SALIDA Y FINALIZAR -->
        <!-- ============================================= -->
        <div class="card shadow mb-4">
            <div class="card-header bg-info text-white">
                <h5><i class="fas fa-list-ol"></i> 3. Medicamentos a Surtir</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Medicamento (Lote)</th>
                                <th>Cantidad</th>
                                <th class="text-center">Quitar</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-salida">
                            <!-- Los items se añadirán aquí con JS -->
                            <tr id="fila-vacia">
                                <td colspan="3">Aún no se han añadido medicamentos.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Aquí es donde JS pondrá los inputs ocultos para el POST -->
                <div id="hidden-inputs-container"></div>

                <button type="submit" class="btn btn-primary btn-lg w-100" id="btn-finalizar-salida" disabled>
                    <i class="fas fa-check-circle"></i> Finalizar y Generar PDF
                </button>
            </div>
        </div>

    </form>
</div>
{% endblock %}

{% block extra_js %}
<!-- El nuevo cerebro de la página -->
<script src="{% static 'farmacia/js/salida_medicamentos.js' %}"></script>
{% endblock %}